
package main

import (
    "bufio"
    "fmt"
    "io"
    "os/exec"
    "strings"
    "testing"
)

func TestConnectToRouter16(t *testing.T) {
    // Create the docker exec command
    cmd := exec.Command("docker", "exec", "-i", "clab-frrlab-router2", "/bin/bash")

    // Connect to the command's standard input, output, and error
    stdin, err := cmd.StdinPipe()
    if err != nil {
        fmt.Println("Error obtaining stdin pipe:", err)
        return
    }
    stdout, err := cmd.StdoutPipe()
    if err != nil {
        fmt.Println("Error obtaining stdout pipe:", err)
        return
    }
    stderr, err := cmd.StderrPipe()
    if err != nil {
        fmt.Println("Error obtaining stderr pipe:", err)
        return
    }

    // Start the command
    if err := cmd.Start(); err != nil {
        fmt.Println("Error starting command:", err)
        return
    }

    // Create a scanner to read from the command's output
    scanner := bufio.NewScanner(stdout)

    // Create a buffer to store output lines
    var outputLines []string

    // Send commands and read output sequentially
    go func() {
        // Send commands
        commands := []string{
            "vtysh\n",
            "configure terminal\n",
            "exit\n",
            "exit\n",
        }
        for _, cmd := range commands {
            if _, err := io.WriteString(stdin, cmd); err != nil {
                fmt.Println("Error writing command:", err)
                return
            }
            // Sleep briefly to allow time for output to be processed
            time.Sleep(100 * time.Millisecond)
        }

        // Read output
        for scanner.Scan() {
            line := scanner.Text()
            outputLines = append(outputLines, line)
            fmt.Println(line)
            // Check if the prompt indicating successful completion of the commands is reached
            if strings.Contains(line, "#") {
                break
            }
        }

        if err := scanner.Err(); err != nil {
            fmt.Println("Error reading output:", err)
        }
    }()

    // Read error in main goroutine
    go func() {
        scanner := bufio.NewScanner(stderr)
        for scanner.Scan() {
            fmt.Println(scanner.Text())
        }
        if err := scanner.Err(); err != nil {
            fmt.Println("Error reading stderr:", err)
        }
    }()

    // Wait for the command to finish
    if err := cmd.Wait(); err != nil {
        fmt.Println("Error waiting for command to exit:", err)
        return
    }
}
